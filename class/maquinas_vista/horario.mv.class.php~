<?
class Plugin_vista_horario extends Plugin_vista_maquina_web
{
	public function obtener_tipo_vista() {return Plugin_vista_maquina_web::TIPO_VISTA_HTML;}

	private $curso=null;
	private $usuario=null;

	public function mostrar_herramientas() {return null;}

	public function obtener_array_css()
	{
		$resultado=array('comunes', 'interfaz_usuario', 'horario');
		return $resultado;
	}

	public function obtener_array_js()
	{
		$resultado=array('lector_doc', 'lector_XML', 'interfaz_usuario', 'form', 'horario');
		return $resultado;
	}

	public function &logica_vista($get, $post)
	{
		$this->usuario=&$this->acc_maquina_web()->obtener_usuario();
		$id_curso=isset($get['id_curso']) ? $get['id_curso'] : 0;
		$this->curso=new Curso($id_curso);

		if(!$this->curso->pertenece_a_y_es_valido($this->usuario))
		{
			$resultado=new Resultado_logica_redireccion('defecto', 0);
		}
		else
		{
			$resultado=new Resultado_logica_redireccion('defecto', 1);
		}

		return $resultado;
	}

	public function componer_url(Resultado_logica_redireccion &$l)
	{
		return Factoria_urls::vista_horario_acceso_no_permitido();
	}

	public function generar_vista()
	{
//		$url_volver=Factoria_urls::vista_grupo($this->grupo);
	
		$VER_TABLA=$this->generar_tabla();
		$VER_CONFIG=$this->generar_config();

		return <<<R

<div id="horario">

	
	<h2>{$this->curso->acc_titulo()} :: Horarios</h2>

	{$VER_CONFIG}

	{$VER_TABLA}

</div>
R;

//<input type="hidden" name="idc" value="{$this->curso->ID_INSTANCIA()}" />
	}

	public function generar_title(){return "Horario :: ".$this->curso->acc_titulo();}

	public function mostrar_plantillas()
	{
		$SELECTOR=$this->generar_selector_contenido();
		$FORM_FRANJAS=$this->generar_form_franjas();

		return <<<R

{$FORM_FRANJAS}
{$SELECTOR}

R;
	}

	/**********************************************************************/

	private function generar_config()
	{
		$franjas=$this->curso->acc_franjas_horario();
		$clave_estado_logica=Maquina_web::CLAVE_ESTADO_LOGICA;

		$contenido_configurar_horario=<<<R

		<form class="iu_form" method="post" action="" id="form_config_horario" onsubmit="return false;" >
			<input type="hidden" name="{$clave_estado_logica}" value="configurar_horario" />
			<input type="hidden" name="idc" value="{$this->curso->ID_INSTANCIA()}" />
	
			<dl>
				<dt>Franjas en horario (max. 10):</dt>
				<dd><input type="text" name="franjas" value="{$franjas}" /></dd>
			</dl>

			<dl>			
				<input type="button" name="btn_ok" value="Guardar" />
			</dl>

			<p class="iu_aviso">
			Establecer una cantidad de franjas menor 
			que la actual causar&aacute; el borrado de la informaci&oacute;n
			de horario sobrante.
			</p>
		</form>
R;

		$plegado=new IU_plegado(null, null);
		$plegado->establecer_clase('form_config_horario');
		$plegado->establecer_valor_boton('Configurar horario');
		$plegado->establecer_contenido($contenido_configurar_horario);
		return $plegado->mostrar();
	}

	private function generar_tabla()
	{
		if(!$this->curso->es_horario_configurado())
		{
			return <<<R
	<div class="no_config">
		A&uacute;n no has configurado tu horario para este curso.
		Para empezar, configura tu horario con la cantidad de franjas
		que desees.
	</div>
R;
		}
		else
		{
			$total_franjas=$this->curso->acc_franjas_horario();

			$franjas=Horario_franja::obtener_array_para_curso($this->curso);
			$contenidos=Horario_contenido::obtener_array_para_curso($this->curso);
		
			$DF=new Despachador_franjas($franjas);
			$DC=new Despachador_contenidos($contenidos);

			$CUERPO=null;

			$f=1;
			while($f <= $total_franjas)
			{
				$fila=null;

echo $f.' ';

				$fila.=self::componer_franja($DF->obtener($f));
				$d=Horario_contenido::LUNES;
				while($d <= Horario_contenido::VIERNES)
				{
					$fila.=self::componer_contenido($DC->obtener($d, $f));
					++$d;
				}

				++$f;

				$CUERPO.=<<<R

			<tr>
{$fila}
			</tr>
R;
			}

			return <<<R
	<table id="tabla_horario">
		<thead>
			<th>Hora</th>
			<th>Lunes</th>
			<th>Martes</th>
			<th>Mi&eacute;rcoles</th>
			<th>Jueves</th>
			<th>Viernes</th>
		</thead>
		<tbody>
{$CUERPO}
		</tbody>
	</table>
R;
		}
	}

	private function componer_franja(Horario_franja &$f)
	{
		return <<<R

				<td class="franja" data-tipo="f" data-id="{$f->ID_INSTANCIA()}" >{$f->acc_titulo()}</td>
R;
	}

	private function componer_contenido(Horario_contenido &$c)
	{
		return <<<R

				<td class="contenido" data-tipo="c" data-id="{$c->ID_INSTANCIA()}" >{$c->traducir()}</td>
R;
	}

	private function generar_selector_contenido()
	{
		$VER_ACTIVIDADES=null;
		$i=1;
		while($i < Horario_contenido::MAX_TIPO_COMUN)
		{
			$traduccion=Horario_contenido::traducir_tipo_comun($i);
	
			$VER_ACTIVIDADES.=<<<R

				<li data-val="{$i}">{$traduccion}</li>
R;

			++$i;
		}

		$grupos=Grupo::obtener_para_usuario_y_curso($this->usuario, $this->curso);

		$VER_GRUPOS=null;
		foreach($grupos as $clave => &$valor)
		{
			$VER_GRUPOS.=<<<R
				
				<li data-val="{$valor->ID_INSTANCIA()}" >{$valor->acc_titulo()}</li>
R;
		}

		$clave_estado_logica=Maquina_web::CLAVE_ESTADO_LOGICA;

		return <<<R

	<div id="selector_contenido">

		<form id="form_selector_contenido" class="oculto" onsubmit="return false;">
			<input type="hidden" name="{$clave_estado_logica}" value="actualizar_contenido" />
			<input type="hidden" name="idcon" value="" />
			<input type="hidden" name="tipcon" value="" />
			<input type="hidden" name="valcon" value="" />
			<input type="hidden" name="idc" value="{$this->curso->ID_INSTANCIA()}" />
		</form>

		<p>Seleccionar un grupo o actividad</p>

		<div class="columnas">

			<div class="col1">
				<h3>Grupos</h3>
				<ul id="lista_grupos">
	{$VER_GRUPOS}
				</ul>
			</div>
			<div class="col2">
				<h3>Actividades</h3>
				<ul id="lista_actividades">
	{$VER_ACTIVIDADES}
				</ul>
			</div>

		</div>

		<input type="button" class="iu_input_defecto" value="Cerrar" />

	</div>
R;
	}

	private function generar_form_franjas()
	{
		$clave_estado_logica=Maquina_web::CLAVE_ESTADO_LOGICA;

		return <<<R
	<div id="contenedor_form_franja">

		<p>Nombre para la franja</p>

		<form id="form_franja" class="iu_form" onsubmit="return false;">
			<input type="hidden" name="{$clave_estado_logica}" value="actualizar_franja" />
			<input type="hidden" name="idf" value="" />
			<input type="hidden" name="idc" value="{$this->curso->ID_INSTANCIA()}" />

			<dl>
				<dt>Nombre:</dt>
				<dd><input type="text" name="titulo" value="" /></dd>
			</dl>

			<dl>
				<input type="button" name="btn_ok" value="Guardar" />
				<input type="button" name="btn_cancelar" value="Cancelar" />
			</dl>
		</form>
	</div>
R;
	}
};

class Despachador_franjas
{
	private $franjas=array();

	public function __construct(array $a)
	{
		foreach($a as $clave => &$valor) $this->franjas[$valor->acc_posicion()]=&$valor;
	}

	public function &obtener($f) {return $this->franjas[$f];}
}

class Despachador_contenidos
{
	private $contenidos=array();

	public function __construct(array $a)
	{
		foreach($a as $clave => &$valor) 
		{
			$dia=$valor->acc_dia();

			if(!isset($this->contenidos[$dia])) $this->contenidos[$dia]=array();
			$this->contenidos[$dia][$valor->acc_posicion()]=&$valor;
		}
	}

	public function &obtener($d, $f) {return $this->contenidos[$d][$f];}
}

?>
